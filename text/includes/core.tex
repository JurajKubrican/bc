\section{Analıza problému}
%Súèasnı stav riešenej problematiky
\noindent 


\subsection{Relaèné}
%https://en.wikipedia.org/wiki/Relational_database
\noindent Relaèná databáza je databáza, v ktorej sú údaje uloené pod¾a relaèného databázového modelu podla  E. F. Codda z roku 1970. Pod¾a Relaèného modelu sú dáta uloené v tabu¾kách. Jeden riadok tabu¾y je jeden záznam. Stlpec tabu¾y reprezentuje jeden atribút objektu.
\noindent Väzby (vztahy) medzi tabu¾ami sú riešené pomocou unikátnych identifikátorov tzv. k¾úèov. jhedna tabu¾ka obsahuje k¾úè, èo je atribút ktorı unikátne identifikuje kadı záznam a druhá tabu¾a obsahuje tzv cudzí k¾úè, atribút ktorı odkazuje na záznam v prvej tabu¾ke.
\noindent Nevıhoda tohto prístupu sa však ukazuje v škálovatelnosti. Pri vyh¾adávaní kadé toto prepojenie pridáva vıpoètovú komplexitu, keïe v kadej da¾šej prepojeniej tabu¾ke treba vyhlada záznam s poadovanım k¾úèom (O(log(n))). Všetky pouívané relaèné databázové systémy riešia tento problém škálovate¾nosti pouitím indexov a rôznymi inımi optimalizáciami, no pokial sú naše dáta štrukturované s ve¾a prepojeniami systém sa spomalí.
   
%TODO obrazok relations in grapg vs relational

\subsection{Grafovı model}
%TODO pekny uvod
\noindent Modelovanie grafovej databázy prirodzene zapadá do spôsobu akım bene abstrahujeme problémy pri vıvoji softvéru. Objekty opisujeme obdånikmi alebo kruhmi a súvislosti medzi nimi opisujeme šipkami, èi èiarami. Moderné grafové databázy sú viac ako akáko¾vek iná databézová tachnológia vhodné na takúto reprezentáciu, lebo to, èo namodelujeme na papier vieme priamo naimplementova v našej grafovej databáze.\\

\noindent Grafové databázy vyuívajú model ktorı pozostáva z vrcholov, hrán, atribútov a znaèiek. Vrcholy obsahujú atribúty, a sú oznaené jednou alebo viacerymi znaèkami. Tieto znaèky zoskupujú vrcholy, ktoré zastávajú rovnakú rolu v rámci aplikácie. \\
\noindent Hrany v grafovıch databázach spájajú vrcholy a budujú štrukúru grafu. Hrana grafu má dy smer, názov, vıchodzí vrchol, cie¾ovı vrchol a cie¾ovı vrchol. Fakt, e hany musia ma smer a názov pridáva to sémantickú preh¾adnos do grafu, ak svolíme správne názov vieme rıchlo identifikova štruktúru grafu a identifikova vıznam vzahov. Hrany mô u rovnako ako vrcholy obsahova aj atribúty. Atrbúty v hranách môu by praktické na pridanie kvalitatívnych dát (napr. váha, vzdialenos) ku vzahom, tieto dáta sa potom môu poui pri preh¾adávaní grafu.


\subsection{Vıkon grafovej databázy}
%TODO oh god...
V poslednej dobe je èím dalej tım viac systémov vyaduje spravova a navigova sie vzahov. V tejto oblasti excelujú grafové databázy.





\section{Špecifikácia}
\begin{enumerate}
	\item Funkcionálne poiadavky
	\begin{enumerate}
		\item Aplikácia bude umonoiva registráciu a prihlásenie pouívate¾a
		\item Pri registrácií sa budú vyadova rpihlasovacie údaje: e-mail, heslo. Okrem toho sa bude vyadova zadnie mena a domáceho miesta. Toto domáce miesto bude moné vyh¾ada v online databáze.
		\item Po prihlásení pouívate¾a sa mu zobrazí obrazovka s mapou, zoznamom ob¾úbenıch destinácií, ktoré chce navštívi a zoznam odporúèanıch destinácií
		\item Na mape bude vyobrazené pouívate¾ove domáce miesto a všetky destinácie ktoré ma v zozname ob¾úbenıch destinácií. Po kliknutí na destináciu sa pouívate¾ovi otvorí príslušnı riadok v zozname ob¾úbenıch.
		\item V zozname ob¾úbenıch budú všetky miesta, ktoré si pouívate¾ pridal. Zoznam bude vo forme tabu¾y riadok bude obsahova Meno destinácie a lokalitu v ktorej sa destinácia nachádza. V riadku tie bude tlaèidlo na vymazanie destinácie z ob¾úbenıch a tlaèidlo na zobrazenie detajlov.
		\item V detajloch ob¾úbeného miesta bude zoznam ostatnıch ¾udi ktorí dané miesto majú v ob¾úbenıch a vıpis monıch trás z domáceho miesta pouívate¾a do destinácie.
		\item V zozname odporúèanıch destinácií budú destinácie ktoré majú v ob¾úbenıch pouívate¾ia, ktorí majú v ob¾úbenıch rovnaké miesta ako miesta, ktoré má v ob¾úbenıch prihlásenı pouívate¾. Vynechané budú miesta, ktoré u prihlásenı pouívate¾ má  ob¾úbenıch. Kadá poloka z odporúcanıch sa bude da jednoducho prida do ob¾úbenıch prikáseného pouívate¾a.
		\item V aplikácií bude obrazovka s nastaveniami, na ktorej si bude èlovek môc zmeni heslo, domáce miesto.
		\item V aplikácií bude obrazovka kde si bude pouívate¾ vybra niko¾ko zo svojich ob¾úbenıch miest a necha si vyráta najkratšiu trasu z domáceho miesta cez všetky zvolené miesta a potom spa. (TSP)



	\end{enumerate}
	\item Nefunkcionálne poiadavky
	\begin{enumerate}
		\item Systém bude zrealizovanı na webovej platforme.
		\item Aplikácia bude vyuíva natívnu grafovú databázu.
		\item Aplikácia bude by kompatibilná s webovımi prehliadaèmi Google Chrome Mozilla Firefox, Microsoft Edge, Microsoft Internet Explorer.
		\item Uívate¾ské rozhranie systém musí by plne pouite¾né aj na mobilnıch telefónoch s OS Android a IOS.
		\item Aplikácia bude implementovanı s pouítím jayka PHP a PHP frameworku.
		\item Systém bude nasadenı na virtuálnom serveri s operaènım systémom  Ubuntu 16.04.2 LTS poskytnutom Ústavom informatiky a matematiky FEI STU.
	\end{enumerate}

\end{enumerate}


\section{Vıvoj}
%\noindent Fáza vıvoja sa delí na dve èasti: návrh a implementácia. V èasti návrhu narvhneme štruktúru projektu, upresníme 

\subsection{Návrh}
\noindent V èasti návrhu projektu popíšeme prípady pouitia, 

\subsubsection{Usecase diagramy}
\noindent
\begin{figure}
	\centering
	\includegraphics[width=10cm]{uml/usecase-login-settings.pdf}
	\caption{Usecase - Registrácia, autentikácia a nastavenia}
	\label{usecase-login-settings}
\end{figure}
\begin{figure}
	\centering
	\makebox[\textwidth]{\includegraphics[width=10cm]{uml/usecase-dash.pdf}}	
	\caption{Usecase - dashboard}
	\label{usecase-dash}
\end{figure}
\begin{figure}
	\centering
	\makebox[\textwidth]{\includegraphics[width=10cm]{uml/usecase-tsp.pdf}}	
	\caption{Usecase - tsp}
	\label{usecase-tsp}
\end{figure}

\subsubsection{Class diagram}
\begin{figure}
	\centering
	\makebox[\textwidth]{\includegraphics[width=12cm]{uml/database.pdf}}	
	\caption{Class diagram}
	\label{class}
\end{figure}


\subsubsection{Role hráèov}
\begin{enumerate}
	\item Neprihlázenı pouívate¾ bude ma prístup na úvodnú stránku. Na úvodnej stánke sa bude môc  buï zaregistrovat, prihlási ak u má vytvornı úèet, alebo si bude môc pozrie mapu a zoznam s najpolulárnejšími destináciami pouívate¾ov aplikácie.
	\item Prihlásenı pouívate¾ má prísup do štyroch subsystémov
	\begin{enumerate}
		\item Dashboard je domáca obrazovka pouívate¾a bude môc na nej vyh¾adáva, pridáva a odstraòova miesta medzi svoje ob¾úbené. Ïaåej si bude môc pozrie detajly destinácie ako rôzne trasy ktoré vedú z jeho domáceho miesta do destinácie a zoznam ostatnıch poívate¾ov, ktorí majú rovnaké miest v ob¾úbenıch. Kliknutím na pouívate¾a bude môc prejs na obrazovku pouívate¾a.
		\item Na obrazovke nastaveni si bude môc pouívate¾ nastavi heslo a zmeni svoje domáce miesto.
		\item Na obrazovke TSP si bude pouívate¾ môc naplánova trasu medzi niektorımi zo svojich ob¾úbenıch miest. Bude si môc pridáva miesta do trasy a odobera ich. Dalej si bude môc prezrie detajly aktuálnej trasy s cenami a mapu s vyobrazenou trasou.
		\item Na obrazovke pouívate¾a si bude prihlásenı pouívate¾ prezrie ob¾úbené destinácie konkrétneho pouívate¾a na mape a v zozname.
	\end{enumerate}
	
\end{enumerate}


\subsection{Implementácia}


\subsubsection{Vıber grafovej databázy}
\noindent Vybrali sme si troch najpopulárnejších predstavie¾ov grafovıch databáz pod¾a \cite{dbrank} rebríèka na  DB-Engines.com. V nasledujúcej v skratke èasti priblíime hitóriu kadého GDBMS ich vıhody, nevıhody pre naše pouitie a proces vıberu pouitej databázy.

%TODO  reasons
%TODO  citations

\begin{enumerate}
	\item{NEO4J}Prvá verzia Neo4J bola vydaná v roku 2007 od vtedy sa stala dlhodobo najpouívanejšou grafovou databázou. Je vyvıjaná Neo Technology, Inc. Neo4j je ponúkaná v dvoch variantách': Neo4j Community je open source (GPLv3) grafová databáza obsahujúca všetky základné funkcií (Ïalej budeme spomína len túto verziu). A Neo4j Enterprise edíciia, ktorá má rozšírené funkcie ako Shardovanie cache pamäte, rozšírené monitorovanie a zálohovnaie za behu.\\
	\noindent Medzi hlavné vıhody neo4j patrí to, e je to dlhodobo najrozšírenejšia grafová datáza, má dobrú dokumentáciu, podporuje mapovanie na objekty\\
	\noindent Nevıhodou je, e podporuje iba grafovı model ukladania údajov.

	\item{OrientDB}OrientDb je vyvıjané od roku 2010 firmou OrientDB LTD. Databáza OrientDB rıchlo nabralo nabrala na popularite a v roku 2015 sa doslatala na druhé miestov rebríèku db-engines. OrientDB sa rovnako ako Neo4j distribuuje v dvoch edíciach: Community - open source (Apache Licence 2.0) so základnımi funkciami a Enterprise edíciou s podpodou migrácie a synchronizácie na Neo4J a pridanymi analytickımi nástrojmi. \\
	\noindent Vıhodou OrientDB je podpora okrem grafového modelu ukladania dát aj dokumentovı a key/value model ukladania údajov.\\
	\noindent Nevıhodou je horšia podpora pre nami vybranı framework Laravel 

	
	\item{Titan} Titan bol od 2012 vyvıjanı skupinou thinkaurelius, no v roku 2017 bol odkúpenı firmou Datstax a projekt Titan bol zastavenı. Projekt je dalej udriavanı ako open source verzia pod menom JanusGraph. Titan je projekt urèenı na ve¾ké distribuovane enterpriese riešenia, je nasadzovanı na  cloudové platformy ako napr. Apache Hadoop, Apache Spark, ... podporuje rôzne distribuované úloné priestory ako napr. Apache HBase,Oracle BerkeleyDB, ... Dalej podporuje rôzne vyhladávacie enginy  ako napr Elasticsearch, Solr, ...\\
	\noindent Toto riešenie je pre naše pouitie nevhodné, lebo na správne fungovanie vyaduje distribuovanı systém.

\end{enumerate}



\section{Implementácia}
\noindent 


\subsection{Pouíté technológie}

\subsubsection{Laravel framework}
\noindent Laravel Framework je komplexnı vo¾ne šíríte¾nı framework. Tento framework je od roku 2015 najpopulárnejší PHP framework. Medzi jeho hlavné vıhody patrí pouitie relatívne novej verzie PHP 5.4, ktorá obsahuje technológie, ktoré v minulosti v PHP chıbali ako menové priestory a anonymné funkcie. Dalej obsahuje velmi silnı nástroj Eloquent ORM pre objektovo relaèné mapovanie darabázy, Blade šablónovací nástroj na rıchlu tvorbu dynamického obsahu. \\
\indent Komplexita Frameworku Laravel je však aj jeho hlavnou nevıhodou, nieje vhodnı na menšie projekty. V rıchlosti patrí medzi priemer PHP frameworkov. 


\subsubsection{NeoEloquent OGM}
\noindent NeoEloquent OGM je v¾ne šírite¾ná kninica, ktorá umoòuje vyuíva grafovú databázu neo4j spolu s existujúcim dátovım modelom vo frameworku Laravel. Štruktúra NeoEloquent je modelovaná podla existujúceho  Eloquent Modelu a preto je jeho integrácia do ekosystému Laravel 
%todo


\subsubsection{Mapbox.js}
\noindent Mapbox.js je komerèná kninica na vytváranie projektov s interaktívnymi mapami. Je zaloená na vo¾ne šírite¾nej kninici Leaflet, rozširuje túto kninicu o funkcie ako automatické zoskupovanie bodov do skupín a poskytuje bohatú a preh¾adnú dokumentáciu. My pouiívame verziu zdarma, ktorá je obmedzená na 50000 zobrazení maky na mesiac.\\
Mapbox.js podporuje štandartnı formát dát GeoJSON, tento formát umonuje uklada dáta o polohe, type bodu, rôznych atribútov upresnujúcich vizuál zobrazovaného bodu. Tento formát dalej umonuje uklada geometrické útvty a krivky.

\subsubsection{Rome2Rio Api}
\noindent Rome2Rio je portál ktorı zbiera údaje o cenách dopravy po celom svete a umonuje vyh¾ada cenu cesty medzi dvomi ¾ubovolnımi destináciami. Rome2Rio taktie poskytuje nieko¾ko otvorenıch a platenıch API.
%TODO

\subsection{inštalácia a nastavnie Laravel Framework-u}
\noindent Na inštaláciu frameworku Laravel sme pouili nástroj pre správu PHP balíkov \textit{Composer}. Pomocou tohto nástroja sme nainštalovali balík \textit{laravel/installer}  \cite{laravel}, následne sme poitím prikazu \textit{laravel new projekt} vytvorili prieèinok so základnou inštaláciou frameworku.


%https://debian.neo4j.org/
\subsection{Inšatlácia a Konfigurácia Databázy neo4j}
\noindent Aby sme mohli nainštalova databázu Neo4j muíme si najprv do systému prida repozitár Neotechnology, potom je nám k dispozicií na inštaláciu balík neo4j. Po inštalácií je nám heï dostupné administráèné rozhraniel databázy na adrese: \textit{localhost:7474}. Pri prvom prihásení sme vyzvaní na zmenu hesla.\\
\noindent Keïe základná inštalácia frameworku Larave lneobsahuje ovládaè pre databázu neo4j museli sme pou ovládaè integrovanı v balíku NeoEloquent, to sa registráciou poskytovate¾a sluby. Po  zaregistrovaní sluny NeoEloquentServiceProvider sa automaticky zaregistuje ovládaè pre databázu a pridajú sa nové monosti pre konfiguráciu databázy. Následne staèí vykona štandartnú konfiguráciu mena hostite¾a, port a prístupovıch úrajov.\\
Na získanie zvialeného prístupu k administraènému rozhaniu databázy bez otvorenia portu 7474 verejnosti vyuívame SSH tunel. Administraèné rozhranie pouíva okrem portu 7474 ešte port 7687 lebo na komunikáciu s databázou vyuíva technológiu WebScoket.


 
\begin{algorithm}
\lstset{
   language=PHP,
   basicstyle=\small\sffamily,
   frame=none,
   numbers=left,
   xleftmargin=5.0ex,
   numberstyle=\tiny,
   stepnumber=1,
   showstringspaces=false,
   keywordstyle=\color{blue}\bfseries
   }
\lstset{emph={%  Adjust any special keywords
   printf%
   },emphstyle={\color[rgb]{1,0,0}\bfseries}%
}%
\begin{lstlisting}
    $app->register('Vinelab\NeoEloquent\NeoEloquentServiceProvider');
...
 'default' => env('DB_CONNECTION', 'neo4j'),

    'connections' => [
        'neo4j' => [
            'driver' => 'neo4j',
            'host'   => env('DB_HOST', 'neo4j'),
            'port'   => env('DB_PORT', 'neo4j'),
            'username' => env('DB_USERNAME', 'neo4j'),
            'password' =>  env('DB_PASSWORD', 'neo4j'),
        ],
    ],
 \end{lstlisting}
\caption{Ukáka algoritmu}
\label{euclid}
\end{algorithm}




\subsection{OGM}
\noindent Keïe framework Laravel natívne obsahuje len ovládaèe pre relaèné databázové ovládaèe a nástroj na objektovo relaèné mapovanie Eloquent. 
Pouili sme volne šírite¾nı balík NeoEloquent, ktorı obsahuje ovládaè pre databázu Neo4J a zároveò rozširuje dátovı model o prvky grafovej datbázy. NeoEloquent umonuje manipuláciu s vrcholmy aj hranami v Neo4J. Manipulácia s vrcholmi je rovnaká ako s entitami v relaènej databáze, NeoEloquent umonuje vytvára periztentné objekty, upravova ich a vyh¾adáva v nich. Pri práca s hranami je mierne odlišná. Najprv treba zadefinova ktorı objekt môe ma aké vzahy, tieto vzahy treba unikátne identifikova ich typom a kardinalitou. Tento vzah vraciame ako návratovú hodnotu funkcie daného objektu. Vrátenı objekt sa správa podobne ako objekt, dá sa vytvára mupravova a v prípade vyššej kardinality aj vyhladáva. \\
V nasledujúcom príklade vidíme implementáciu dvoch rôznych tried. Trieda poívate¾a dedí od triedy NeoEloquent a teda sa stáva naviazanou na vrchol v našej databáze. Názov tejto entity v databáze je spojením menováho pristoru v ktorom bol vytovrenı a názvu triedy, take v našom prípade AppUser. Trieda obsahuje verejné funkcie, ktoré vracajú objekty hrán. Objektı hrán dostávame volaním zdedenıch funkcii hasMany, hasOne a belongToMany. Ako prvı argument funkcie berú názov triedys ktorou vzach chceme vráti, ako druhı argument berie typ hrany, pomocou tohto typu je identifikovanı typ hrany v databáze. 

\begin{algorithm}
\lstset{
   language=PHP,
   basicstyle=\small\sffamily,
   frame=none,
   numbers=left,
   xleftmargin=5.0ex,
   numberstyle=\tiny,
   stepnumber=1,
   showstringspaces=false,
   keywordstyle=\color{blue}\bfseries
   }
\lstset{emph={%  Adjust any special keywords
   printf%
   },emphstyle={\color[rgb]{1,0,0}\bfseries}%
}%
\begin{lstlisting}
namespace App;

class User extends \NeoEloquent implements Authenticatable {

  //  Jeden pouívate¾ môe ma v ob¾úbenıch viac miest 
  public function follows() {
    return $this->hasMany('App\Place', 'FOLLOWS');
  }

  //  Jeden pouívate¾ má jedno miesto ako domáce
  public function home() {
    return $this->hasOne('App\Place', 'HOME');
  }
  ...
}
...
class Place extends \NeoEloquent {
   // Inverznı vzah - jedno miesto má v ob¾úbenıch viac pouívate¾ov
   public function followers(){
    return $this->belongsToMany('App\User','FOLLOWS');
  }
  ...
}
\end{lstlisting}
\caption{Ukáka tiredy neoEoquent}
\label{codeauth}
\end{algorithm}


\subsection{Autentifikácia}
\noindent  Jednou zo silnıch stránok Frameworku Laravel je práve autentifikácia. Pre vytvornie základnej funkcionality registrácie, prihlasovania a obnovenia zabudnutého hesla staèí poui Artisan - konzolu frameworku príkaz (\textit{php artisan make:auth}) , ktorá vytovrí URL cesty, obrazovky, triedu pouívate¾a a treidy obluhujúce túto funkcionalitu. My sme potrebovali poui vlastnú triedu pouívate¾a, ktorá dedí od našeho balíka NeoEloquent, na implementáciu autentifikácie staèilo naimplementova rozhranie Authenticatable, prida do treidy pouívate¾a pole skrytıch a verejnıch atribútov, a poui charakteristiku 'AuthenticableTrait' a autentifikácia fungovala rovnako ako s relaènou databázov vïaka tomu, e NeoEloquent pokrıva všetky funckie natívneho Eloquent ORM. 

\begin{algorithm}
\lstset{
   language=PHP,
   basicstyle=\small\sffamily,
   frame=none,
   numbers=left,
   xleftmargin=5.0ex,
   numberstyle=\tiny,
   stepnumber=1,
   showstringspaces=false,
   keywordstyle=\color{blue}\bfseries
   }
\lstset{emph={%  Adjust any special keywords
   printf%
   },emphstyle={\color[rgb]{1,0,0}\bfseries}%
}%
\begin{lstlisting}

namespace App;

use Illuminate\Contracts\Auth\Authenticatable;
use Illuminate\Auth\Authenticatable as AuthenticableTrait;

class User extends \NeoEloquent implements Authenticatable {

  use AuthenticableTrait;

// pole verejnıch atribútov
  protected $fillable = [
      'name', 'email', 'password', 'tspCache'
  ];

  // pole skrıtıch atribútov
  protected $hidden = [
      'password', 'remember_token',
  ];
...
}
\end{lstlisting}
\caption{Ukáka autentifikovat¾nej triedy}
\label{codeauth}
\end{algorithm}



\subsection{API}
\noindent Framework Laravel poskyruje silnı nástroj pre tvorenie ciest. 

%geojson  lonLat
\subsection{GeoJson}
\noindent Ako zdrojovvı formát dát pre všetky mapy v našej aplikácií pouívame šantdartnı formát GeoJson. Na priklade \ref{geojson} vidíme kolekciu mapovıch


\subsection{Mapa}
\noindent Na vizualizáciu destinácií a trás sme na rôznych miestach a plikácií pouili JavaScriptovú kniènicu Mapbox.js. Na inicializáciu mapu sme naimplementovali funkciu \ref{coderecommendmap}.\\ 
%todo ref tech
\noindent Keïze Mapbox.js rozširuje kninicu Leaflet, všetky funkcie kninice sa volajú z globálneho objektu \textit{L}. Táto funkcia sa zavolá po naèítaní stránky. Keïze sa mapy Mapbox.js sa sahujú z CDN Mapbox musíme naprv aplikáciu identifikova API k¾úèom, ktorı sme si vygenerovali po registrácií. Následne inizializuje samotná mapu volaním funkcie \textit{ L.mapbox.map}. Táto funkcia berie ako prvı paramete id HTML elementu, do ktorého sa má mapa zobrazi, ako druhı parameter berie textovı identifikátor typu mapy, ktorı chceme zobrazi. Po inicialiácií sa vytvorí vrstva pre mapu ktorá bude obsahova markery destinácií. Dáta ktoré obsahujú geografickú polohu destinácií sa vyiadajú vo formáte GeoJson z API našej aplikácie. Keïe pri malom priblíeni mapy by sa nedali zrete¾ne rozlíši destinácie ktoré sú blízko pri sebe, po naèítaní dát vytvoríme vrstvu clusterov pomocou funkcie \textit{L.MarkerClusterGroup}. Táto vrstva spojí blízke body do clusterov, následne skryje znaky tıchto bodov a nahradí ich znaèkou clusteru. Na pridanie bodov do clusterov sa iteruje cez všetky body, ktoré sú po naèítaní v mape a kadı sa pridá do vrstvy clusterov. Následne sa vrstva clusterov pridá do objektu mapy.\\
%TODO screenshoot markercluster ref


\begin{algorithm}
\lstset{
   language=JavaScript,
   basicstyle=\small\sffamily,
   frame=none,
   numbers=left,
   xleftmargin=5.0ex,
   numberstyle=\tiny,
   stepnumber=1,
   showstringspaces=false,
   keywordstyle=\color{blue}\bfseries
   }
\lstset{emph={%  Adjust any special keywords
   printf%
   },emphstyle={\color[rgb]{1,0,0}\bfseries}%
}%
\begin{lstlisting}
  var map;
  function initMap() {
    // API k¾úè
    L.mapbox.accessToken = 'key';

    // Inicializácia mapy s vo¾bou typu mapy
    map = L.mapbox.map('main_map', 'mapbox.k8xv42t9');

    // Pridávanie vrstiev na mapu
    L.mapbox.featureLayer()
      .loadURL("/placeapi?type=geojson&filter=suggested")
      .on('ready', function(e) {
	
    //Vytváranie vrstvy clusterov
        var clusterGroup = new L.MarkerClusterGroup();
        e.target.eachLayer(function(layer) {
          clusterGroup.addLayer(layer);
          
    //Pridanie funkcionality kliknutia na mesto v zozname
          $(document).on('click','.zoom-map[data-id="' + layer.feature.properties.title + '"]',function(){
            map.setView(layer.getLatLng(),8);
          })
        });
        
     // Úvodné pridanie vrstvy a centrovanie 
        map.addLayer(clusterGroup);
        map.fitBounds(clusterGroup.getBounds());
      });
  }
}
\end{lstlisting}
\caption{Zobrazenie odporúèanıch miest}
\label{coderecommendmap}
\end{algorithm}



\subsection{Vykreslovanie tabu¾iek}
\noindent Aby sme zpelšili UX stránky rozhodli sme sa na vykreslovanie dynamického obsahu vyui namiesto HTML obsahu renderovaného na serveri javascriptovú kninicu na prácu so šablónami a, dynamickı obsah naèítavame z API našej aplikácie vo formáte JSON. Na vykreslovanie dynamickáho obsahu sme zvolili kninicu Handlebars.js. Na príklade \ref{dynamictable} môeme ukáza príklad našej implementácie dynamickej tabu¾ky pre hlavnú tabu¾ku zobrazujúcu destinácie a ich detajly.\\
Najprv je zadeklarovaná premenná v \textit{template} ktorá bude neksôr obsahova funkciu renderujúcu šablónu. Potom je zadeklarovaná funckia \textit{refreshPage}, ktorá bude volaná vdy, keï nejaká funkcia spustí event s menom \textit{appRefresh}. Táto funkcia vyuije AJAX API kninice jQuery a stiahne potrebné dáta, potom vyuije funkciu \textit{template}, ktorá do argumentu berie dáta vo forme po¾a obejktov a vracia vyrenderované HTML ktoré sa následne vkladá na stránku.\\
\noindent V druhej èasti kódu sa najprv zavolá funkcia \textit{Handlebars.compile} do argumentu zoberie šablónu ktorá je uloená v elemente s id \textit{places-template}. Ako návratovú hodnotu vráti funkciu, ktorú uloíme pod menom \textit{template}. Následne sa na event \textit{appRefresh} naviae volanie funkcie \textit{refreshPage} a prvı krát sa spustí tento event.\\
\noindent Naša šablona \textit{places-template} obashuje aj aktívne linky a v nasledujúcom bloku je príklad implemenácie vymazania miesta z ob¾úbenıch. Na generálny event \textit{click} je naviazanı filtrovanı event, torı spustí AJAX dotaz na vymazanie miesta z ob¾úbenıch ak element ktorı event spustil obsahuje triedu \textit{delete} a atribút\textit{data-id}.

\begin{algorithm}
\lstset{
   language=JavaScript,
   basicstyle=\small\sffamily,
   frame=none,
   numbers=left,
   xleftmargin=5.0ex,
   numberstyle=\tiny,
   stepnumber=1,
   showstringspaces=false,
   keywordstyle=\color{blue}\bfseries
   }
\lstset{emph={%  Adjust any special keywords
   printf%
   },emphstyle={\color[rgb]{1,0,0}\bfseries}%
}%
\begin{lstlisting}
var template;  
function refreshPage (){
  $.get('/placeapi?type=template', function (data) {
    data = JSON.parse(data);
    home = data.places[0];
    $('#places_body').html(template(data));
  });
}

$(document).ready(function() {

  template = Handlebars.compile($("#places-template").html());
  
}).on('appRefresh',refreshPage).trigger('appRefresh');

 $(document).on('click', '.delete[data-id]', function (e) {
    e.preventDefault();
    $.ajax({ url: '/placeapi/' + $(this).data('id'), type: 'POST',
      success: function () {
        $(document).trigger('appRefresh');
      }
    });
  });
\end{lstlisting}
\caption{Implementácia dynamickej tabulky}
\label{dynamictable}
\end{algorithm}




